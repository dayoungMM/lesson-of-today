# 포털 메인 페이지가 높은 트래픽을 견디는 방법

## 일반적인 분산 처리 모델의 한계

### 로드밸런서로 구성한 일반적인 3계층(3-Tier)분산처리 모델


- 로드밸런서가 트래픽을 분산해서 웹서버에 요청
- 로드밸런서의 failure를 대비해 `다중화` 하고, `DNS 라운드로빈`(순차적으로 할당. 자동적으로 시간에 따라 스케줄링) 또는 `가중치 편성 방식` 등으로 보완

### 한계

- `WAS`에 문제가 생겼을 때 다중화로 해결하기 어려운 경우
    - WAS에 문제가 생겼을 때 웹서버가 다른 WAS를 찾도록 해야한다
    - 사용자가 로그인한 상태라면 WAS에 세션 클러스터링을 설정해야한다 → 추가 세팅작업 필요, 관리지점 증가
- `DB`에 문제생겼을 때 다중화로 해결하기 어려운 경우
    - 데이터 동기화 등으로 인해 DB 다중화 어려움
    - 사용하는 데이터 베이스가 RDB라면 다중화 및 데이터 분산처리 어려움
    - 사용하는 데이터베이스가 NoSQL이라고 하더라도 다중화+분산처리 하면 정합성, 동기화, 장애복구 시 다수결에 의한 데이터 오염 가능성 등을 고려해야 함


## 네이버 메인페이지의 분산 처리 모델

### 특징 및 요구사항

- 대부분이 데이터 Read 동작이다.
    - 데이터를 save하는 동작이 거의 없기 때문에 분산처리나 다중화에서 트랜잭션을 고려할 필요가 없다.
- 어떤 서버로 접속해도 동일한 내용. (일관성, 로그인 불필요)
- 무슨일이 있더라도 사용자에게 서비스 제공 (빈페이지 X, 고가용성)
- 트래픽 증가에 탄력적 대처 (scale out 하면서 동시에 웹서버 및 WAS 효율성 극대화 가능하도록)

### 사용 기술

1. GCDN(Global CDN)
2. SSI(Server Side Includes)
3. Apache 커스텀 모듈
4. 마이크로 서비스
    1. 서킷 브레이커(Circuit breaker)
    2. 서비스 디스커버리(Service Discovery)

### GCDN

- 개념
    - 메인 페이지의 View와 관련된 소스를 CDN 캐싱 장비에 저장해놓고, 클라이언트 요청시 바로 응답 (웹서버까지 트래픽 가지 않아 빠름)
- 왜 사용했을까? 😮
    - 지리, 물리적으로 떨어져 있는 사용자에게 컨텐츠를 더 빠르게 제공
    - 느린 응답속도.  다운로딩 타임을 극복
    - GSLB(Global Server Load Balaner) 기능을 통해 접속한 IP 주소에서 가장 가까운 CDN 서버로 자동으로 연결하기 때문에 빠르게 서비스할 수 있음
- 작동
    - 최초 요청은 서버로 부터 컨텐츠를 가져와 고객에게 전송하며 동시에 CDN 캐싱 장비에 저장
    - 두번째 요청부터는 CDN 업체에서 지정하는 컨텐츠 만료 시점까지 CDN 캐싱 장비에 저장된 컨텐츠를 전송
    - 자주 사용하는 메인 페이지에 한해 CDN 장비에서 캐싱됨
    - 서버가 파일을 찾는데 실패하는 경우 CDN 플랫폼의 다른 서버에서 컨텐츠를 찾아 엔드유저에게 응답 전송
    - 컨텐츠를 사용할 수 없거나 컨텐츠가 오래된 경우 CDN은 서버에 대한 요청을 프록시로 작동하여 향후 요청에 대해 응답할 수 있도록 새로운 컨텐츠 저장


### SSI

- 개념
    - 웹서버(Apache, NginX 등)에서 지원하는 서버사이드 스크립트 언어.
    - 서버에 있는 특정 파일을 읽어오거나 특정 쿠키 유무의 판별 등 간단한 기능 가능
- 왜 사용했을까? 😮
    - WAS의 할일의 일부를 SSI가 처리하여 WAS의 부담을 줄임

### Apache 커스텀 모듈

- 커스텀이란 무슨의미?
    - Apache HTTP 서버를 그대로 사용하지 않고 APR(Apache Portable Runtime) 기반의 커스텀 모듈로 확장해서 사용
- APR(Apache Portable Runtime)
    - 프레임워크와 비슷하게 운영체제에 독립적으로 HTTP 기반 통신을 처리할 수 있도록 하는 라이브러리
    - 메모리 할당, 메모리 풀링, 파일 I/O, 멀티스레드 관련 처리 등에 필요한 기능을 포함
- 왜 사용했을까?
    - WAS에서 처리할 기능을 웹서버에서 처리할 수 있어서 WAS의 부담을 줄이기 위해
    - SSI에서 불가능한 고급기능을 사용
        - 간단한 외부 시스템 연동(단순히 API 호출하거나 결과값 그대로 사용할 수 있을 때 외부시스템 호출하는 방식)
        - 모든 WAS가 다운되더라도 웹 서버만 정상이면 서비스를 제공할 수 있게 WAS와 통신
    - C 언어 기반이라 실행 성능이 좋음

### 서킷 브레이커

- 개념
    - 외부 서비스의 장애로 인한 연쇄적 장애 전파를 막기 위해 자동으로 외부 서비스와 연결을 차단 및 복구하는 역할을 함
- 왜 도입했을까? 😮
    - MSA 환경에서 failure 확장을 막기 위해 도입
    - 애플리케이션의 안정성과 장애 저항력 높이기 위해
    - MSA 환경에서 네트워크 일시 단절, 트래픽 폭증으로 인한 간헐적 시간 초과 등으로 인해 발생하는 장애 극복
- 구현 라이브러리
    - Netfilx OSS Hystrix (서킷 브레이커 라이브러리)
    - Spring Cloud Netflix( Neflix OSS를 Spring Cloud 프로젝트에서 사용할 수 있도록 랩핑한 라이브러리)


### 서비스 디스커버리

- 개념
    - 동적으로 생성, 삭제되는 서버 인스턴스에 대한 IP 주소와 포트를 자동으로 찾아 설정해줌
- 왜 도입했을까? 😮
    - 클라우드 환경에서 수시로 서버가 추가되고 삭제되는데, 그 때마다 변경되는 IP를 찾아 열결하기 위해
    - Auto Scaling 환경에서는 필수


[https://d2.naver.com/helloworld/6070967](https://d2.naver.com/helloworld/6070967)

[https://goddaehee.tistory.com/173](https://goddaehee.tistory.com/173)