# CAP 이론

- 일관성(Consistency), 가용성(Availability), 분할 내구성(Partition Tolerance)
- 분산된 데이터 베이스 시스템은 이 3가지 특성 중 2가지 특성만을 충족할 수 있고 3가지 모두 충족할 수 없다는 이론
- DB 선택의 한가지 척도로서 사용됨. (무엇을 택하고 무엇을 버릴지 고민해서, 그 특성에 적합한 DB 선택)


## 일관성(Consistency)

- 모든 데이터를 요청할 때 응답으로 가장 최신의 변경된 데이터를 리턴하거나 실패를 리턴
- 모든 읽기에 대해서 DB 노드가 항상 동일한 데이터를 가지고 있어야함
- 일관성을 지키기 위해서는 분산 노드 간의 데이터 동기화를 해야함
    - 데이터 저장결과를 클라이언트로 응답하기 전에 모든 노드에 데이터 저장해 동기화 하는 방법
    - 메모리나 임시파일에 기록하고 먼저 응답한다음, 특정 이벤트로 노드간 데이터 동기화 하는 방법


> 💡 ACID의 C(Consistency)와 다른 개념이다. ACID의 C는 데이터 조작 후에도 무결성을 해치지 말아야 한다는 개념



## 가용성(Availability)

- 모든 요청에 대해서 정상적인 응답을 하는것.
- 장애 대응에 유연하게 대처하는 성질
- 클러스터 노드 일부에서 장애가 발생하더라도 Read, Write등의 동작은 항상 성공적으로 리턴되어야함
- 가용성을 유지하기 위해 데이터 Replication 하는 방법이 대표적
    - master- slave 복제방법
    - 데이터 단위로 중복 저장하는 peer - to -peer 복제 방법

## 분할 내구성(Partition Tolerance)

- DB Node 간의 통신 장애가 발생하더라도 동작해야한다
- 예시
    - Instance A, B 존재
    - A,B 간의 네트워크 장애 발생
    - 유저는 A DB에서 쿼리를 실행.
    - A는 B의 상태를 모르지만 A 자체만으로도 동작 가능

## 2개 밖에 선택을 못한다면, 각각의 단점은 무엇일까?

- CP
    - 완벽한 일관성을 가지기 위해 동기화를 계속 해야하기 때문에 하나의 노드라도 문제가 있으면 트랜잭션 실패 (가용성 저하)
    - 노드가 많아질수록 느려진다
- AP
    - 완벽한 가용성을 구현하기 위해 특정 노드에 장애 생겨도 언제나 응답할 수 있어야한다
    - 동기화가 덜 된 특정 노드에 접근한 트랜잭션은 오래된 데이터를 받아갈수도 있고, 사용자별로 얻는 데이터가 다를 수도 있는 등 일관성 저하 문제가 발생
- CA
    - 일관성과 가용성을 동시에 만족하려면 네트워크 장애를 허용하지 말아야 한다
    - 네트워크 장애가 절대 일어나지 않는 네트워크 구성이란 없다
    - 결국 분산 시스템에서는 네트워크 파티션 허용은 기본적으로 깔고 시작해야한다.

## 실제 DB와 CAP

- CAP 이론처럼 완벽한 CP, AP 시스템은 없다
- configuration에 따라 같은 DB 시스템이여도 성질이 달라지기 때문에 어떤 DB가 어디에 속하는지 단정지을 수는 없다.
- P에 대한 정의도 애매하다
- 이런 문제점을 극복하고자 PECELC 이론이 나왔다.