# 병렬 스트림

## 개념

- 멀티 코어 환경에서 하나의 작업을 분할해 각각의 코어가 병렬적으로 처리하는 것 (멀티 스레드)
- 스트림 병렬화 in java
    - 스트림 파이프라인의 parallel(), parallelStream() 만 호출하면 실행 가능
- ForkJoinTask
    - 병렬 스트림의 동작방식.
    - 작업을 재귀적으로 서브 데이터로 분할(Fork)한 다음 처리한 결과를 합쳐(Join) 전체 결과를 리턴


## 언제 쓰면 좋을까

- 공통점
    - 데이터를 쉽게 나눠서 스레드 분배 용이
    - 참조지역성(locality of reference)가 뛰어남 → 메모리에 연속해서 저장
- 데이터 소스가 ArrayList, HashMap, HashSet, ConcurrentHashmap의 인스턴스 일 때
- 배열
- int 범위
- long 범위
- 종단 연산이 reduction 되거나, anyMatch 처럼 조건 맞으면 바로 리턴하는 함수일 때

## 언제 쓰지 말아야할까

- (병렬화 해도 성능개선 안되거나, 무한 대기 발생 가능. 동시성 이슈)
- 데이터 소스가 Stream.iterate
    - 이전 연산의 결과가 스트림의 입력에 영향을 미친다. 따라서 이전 연산이 완료되어야 다음 스트림으로 넘어갈 수 있기 때문에 분할하기 어려워 성능 하락
- 중간 연산으로 limit
- 병렬화 할 때 주의사항
    - 잘못 병렬화하면 성능 나빠지고, failure 일어날 수 있음
    - 병렬화 한 결과를 순차적으로 정렬할 필요가 있는지 확인하여 종단 메서드를 결정
    - 최적화의 수단일 뿐이므로 병렬화 해서 성능이 향상되는지 확인하고 사용하자


## 동시성 vs 병렬성

- 공통점
    - 멀티스레드의 동작 방식
- 차이점
    - 동시성(Concurrency)
        - 멀티작업을 위해 멀티스레드가 번갈아 가면서 실행하는 성질. 싱글 코어 CPU를 이용한 멀티 작업은 병렬적으로 실행되는것처럼 보이지만 실제로는 동시성 작업이다
        - 멀티 스레드로 이 동시성이라는 특성을 만족시킬 수 있는 것이지 사실 동시성과 멀티스레드는 항상 함께할 수 없는 개념이다
        - 싱글 스레드에서 코루틴(Coroutine)을 이용해서 동시성을 만족시킬 수 있다.
            - 코루틴: 루틴이라는 단위로 루틴간 협력이 가능하게 하는 것
        - 이 때 번갈아 가며 작업을 바꾸는 행위를 콘텍스트 스위칭(Context Switching)이라고 한다
    - 병렬성
        - 멀티 작업을 위해 멀티 코어를 이용해 동시에 실행.
        - 한개 이상의 스레드를 포함하는 각 코어들이 동시에 실행되는 성질